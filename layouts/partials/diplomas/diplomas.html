{{ $diplomas := .diplomas }}
<ul class="diplomas">
  {{ range $diplomas }}
  {{ $short_name := .Params.short_name }}
    <li>
      <a href="{{ .Permalink }}" aria-label="{{ i18n "commons.more_aria" (dict "Title" .Title) }}">
        {{- partial "PrepareHTML" .Title -}}
        {{ with $short_name }}
          <span class="meta">
            {{ partial "PrepareHTML" . }}
          </span>
        {{ end }}
      </a>
      <div class="content">
        {{with .Params.summary}}
        <div class="description">
          {{- . | safeHTML -}}
        </div>
        {{end}}

        <ol class="programs">
          {{- range .Params.programs -}}          
            {{- template "programsList" 
              (dict 
              "context" . 
              "short_name" $short_name
              ) 
              -}}
          {{- end -}}
        </ol>
      </div>
    </li>
  {{ end }}
</ul>

{{- define "programsList" -}}
  <li>
    {{ $formation := site.GetPage (printf "/programs%s" .context.slug) }}
    <div class="program-content">
      <a href="{{ .context.path }}" title="{{ safeHTML (i18n "commons.more_aria" (dict "Title" .context.label)) }}">
        {{- partial "PrepareHTML" (printf "%s %s" .short_name .context.label)  -}}
      </a>
      <div class="program-details">
        <div>
          {{- with .context.children -}}
            <ol>
              {{- range . -}}
              <li>
                <a href="{{ .path }}" title="{{ safeHTML (i18n "commons.more_aria" (dict "Title" .label)) }}">
                  {{- partial "PrepareHTML" (printf "Parcours : %s" .label) -}}
                </a>
              </li>
              {{ end }}
            </ol>
          {{end}}
          <div> 
            <a href="{{ .context.path }}" title="En savoir plus" class="btn">En savoir plus</a>  
            
            {{ with $formation.Params.downloadable_summary }}
            {{- $file := partial "GetMedia" . -}}
            {{- if $file -}}
              {{- $url := $file.url -}}
              {{- if site.Params.keycdn -}}
                {{- $url = $file.direct_url -}}
              {{- end -}}
              <a href="{{ $url }}" download target="_blank" class="btn">{{ i18n "commons.download.singular_name" }}</a>
            {{- end -}}
          {{ end }}
          </div>
        </div>
        {{with $formation.Params.roles}}
          <p class="meta">
            {{ $person := (site.GetPage (printf "/persons/%s" (index (index . 0).persons 0))).Params -}}
            <span class="title">{{- partial "PrepareHTML" ((index . 0).title) -}}</span>
            <span>{{$person.title}}</span>
            {{with  $person.contact_details}} 
              {{with .phone_professional}} 
                <span>{{- partial "PrepareHTML" (printf "- %s" .label) -}}</span>  
              {{end}}
              {{with.email}} 
                <a href="{{.value}}" itemprop="email">{{.label}}</a>
              {{end}}
            {{end}}
          </p> 
        {{end}}
      </div>
    </div>
    <div class="media">
      {{- if $formation.Params.image -}}
        {{- partial "commons/image.html"
            (dict
              "image"    $formation.Params.image
              "sizes"    site.Params.image_sizes.sections.programs.item
            ) -}}
      {{- end -}}
    </div>
  </li>
{{- end -}}